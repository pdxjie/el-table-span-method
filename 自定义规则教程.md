# 自定义合并规则详细教程

## 🎯 什么是自定义合并规则？

默认情况下，表格只会合并完全相同的值。但在实际业务中，我们经常需要更灵活的合并逻辑。自定义规则让你可以用 JavaScript 表达式定义什么情况下两个值应该被合并。

## 📝 基本语法

自定义规则是一个返回 `true` 或 `false` 的 JavaScript 表达式：
- `value1`：第一个值
- `value2`：第二个值
- 返回 `true`：两个值应该合并
- 返回 `false`：两个值不应该合并

## 💡 实用例子详解

### 1. 忽略大小写合并

**场景**：部门名称可能有大小写不一致的情况
```javascript
value1.toLowerCase() === value2.toLowerCase()
```

**数据示例**：

| 员工 | 部门 |
|------|------|
| 张三 | Technology |
| 李四 | TECHNOLOGY |
| 王五 | technology |

**效果**：三个不同大小写的 "Technology" 会被合并成一行

---

### 2. 忽略前后空格

**场景**：Excel 导入的数据可能有多余空格
```javascript
value1.trim() === value2.trim()
```

**数据示例**：

| 产品 | 分类 |
|------|------|
| iPhone | 手机 |
| Samsung | " 手机 " |
| Huawei | "手机  " |

**效果**：带空格的 "手机" 会被正确合并

---

### 3. 数值范围合并

**场景**：薪资在一定范围内的员工合并显示
```javascript
Math.abs(value1 - value2) <= 1000
```

**数据示例**：

| 员工 | 薪资 |
|------|------|
| 张三 | 8000 |
| 李四 | 8500 |
| 王五 | 8800 |
| 赵六 | 12000 |

**效果**：8000、8500、8800 会被合并（差值都小于等于1000），12000 单独一行

---

### 4. 包含关系合并

**场景**：地址中包含相同城市的合并
```javascript
value1.includes(value2) || value2.includes(value1)
```

**数据示例**：

| 员工 | 地址 |
|------|------|
| 张三 | 北京市朝阳区 |
| 李四 | 北京 |
| 王五 | 上海市浦东区 |

**效果**："北京市朝阳区" 和 "北京" 会被合并

---

### 5. 日期月份合并

**场景**：同月入职的员工合并显示
```javascript
new Date(value1).getMonth() === new Date(value2).getMonth()
```

**数据示例**：

| 员工 | 入职日期 |
|------|----------|
| 张三 | 2023-01-15 |
| 李四 | 2023-01-28 |
| 王五 | 2023-02-10 |

**效果**：1月入职的张三、李四会被合并

---

### 6. 正则表达式匹配

**场景**：手机号前三位相同的合并
```javascript
/^(\d{3})/.exec(value1)?.[1] === /^(\d{3})/.exec(value2)?.[1]
```

**数据示例**：

| 员工 | 手机号 |
|------|--------|
| 张三 | 138****1234 |
| 李四 | 138****5678 |
| 王五 | 139****9999 |

**效果**：138 开头的手机号会被合并

---

### 7. 复杂条件组合

**场景**：部门相同且级别相近的员工合并
```javascript
value1.split('-')[0] === value2.split('-')[0] && Math.abs(parseInt(value1.split('-')[1]) - parseInt(value2.split('-')[1])) <= 1
```

**数据示例**：

| 员工 | 部门级别 |
|------|----------|
| 张三 | 技术部-P5 |
| 李四 | 技术部-P6 |
| 王五 | 技术部-P8 |
| 赵六 | 市场部-P5 |

**效果**：技术部的 P5、P6 会被合并（部门相同且级别相差1），P8 和市场部单独显示

---

### 8. 字符串相似度合并

**场景**：产品名称相似度高的合并
```javascript
(() => {
  const similarity = (a, b) => {
    const longer = a.length > b.length ? a : b;
    const shorter = a.length > b.length ? b : a;
    if (longer.length === 0) return 1.0;
    const editDistance = (s1, s2) => {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      const costs = [];
      for (let i = 0; i <= s2.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s1.length; j++) {
          if (i === 0) costs[j] = j;
          else if (j > 0) {
            let newValue = costs[j - 1];
            if (s1.charAt(j - 1) !== s2.charAt(i - 1))
              newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
        if (i > 0) costs[s1.length] = lastValue;
      }
      return costs[s1.length];
    };
    return (longer.length - editDistance(longer, shorter)) / longer.length;
  };
  return similarity(value1, value2) > 0.7;
})()
```

**数据示例**：

| SKU | 产品名 |
|-----|--------|
| A001 | iPhone 15 Pro Max |
| A002 | iPhone 15 Pro |
| A003 | Samsung Galaxy S24 |

**效果**：相似度超过 70% 的产品会被合并

---

### 9. 时间范围合并

**场景**：订单时间在同一小时内的合并
```javascript
Math.floor(new Date(value1).getTime() / (1000 * 60 * 60)) === Math.floor(new Date(value2).getTime() / (1000 * 60 * 60))
```

**数据示例**：

| 订单号 | 下单时间 |
|--------|----------|
| O001 | 2023-12-01 14:15:30 |
| O002 | 2023-12-01 14:45:20 |
| O003 | 2023-12-01 15:20:10 |

**效果**：14点的两个订单会被合并，15点的单独显示

---

### 10. 自定义业务逻辑

**场景**：会员等级合并（VIP和SVIP算高级会员）
```javascript
(['VIP', 'SVIP'].includes(value1) && ['VIP', 'SVIP'].includes(value2)) || value1 === value2
```

**数据示例**：

| 客户 | 会员等级 |
|------|----------|
| 张三 | VIP |
| 李四 | SVIP |
| 王五 | 普通 |
| 赵六 | 普通 |

**效果**：VIP 和 SVIP 会被合并为高级会员，普通会员单独合并

---

## 🔧 使用步骤

1. **导入数据**：上传你的表格文件
2. **选择合并类型**：通常选择"行合并"
3. **选择合并列**：选择需要应用自定义规则的列
4. **选择合并条件**：选择"自定义规则"
5. **输入规则**：复制上面的例子或编写自己的规则
6. **实时预览**：查看合并效果
7. **生成代码**：满意后一键生成代码

## ⚠️ 注意事项

### 安全性
- 自定义规则在安全的沙箱环境中执行
- 如果规则出错，会自动降级为默认的相同值比较

### 性能
- 复杂的规则（如字符串相似度）可能影响大数据表格的性能
- 建议先在小数据集上测试规则

### 调试技巧
- 如果规则不生效，检查数据类型（字符串 vs 数字）
- 使用浏览器开发者工具查看控制台错误信息
- 先写简单规则，再逐步增加复杂度

## 🎯 进阶技巧

### 组合多个条件
```javascript
// 同时满足多个条件
(value1.toLowerCase() === value2.toLowerCase()) &&
(Math.abs(value1.length - value2.length) <= 2)
```

### 处理空值
```javascript
// 空值也合并
(value1 === value2) || (!value1 && !value2)
```

### 使用数组方法
```javascript
// 检查值是否在指定列表中
['管理员', '超级管理员'].includes(value1) &&
['管理员', '超级管理员'].includes(value2)
```

现在你可以根据自己的业务需求，选择合适的规则或组合使用！有任何问题都可以继续询问。